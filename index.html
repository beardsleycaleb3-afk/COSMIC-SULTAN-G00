<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SULTAN_SOVEREIGN_2.2.0 | Jack-In-The-Box</title>
    <style>
        :root { --p-glow: #ff6600; --s-glow: #00ff41; --bg: #000; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; touch-action: none; }
        body { background: var(--bg); color: var(--s-glow); font-family: 'Courier New', monospace; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* Mobile Layout Structure */
        #viewport { flex: 1; position: relative; border-bottom: 2px solid #333; overflow: hidden; }
        #canvas-container { width: 100%; height: 100%; }
        
        .hud { position: absolute; font-size: 10px; pointer-events: none; z-index: 10; text-shadow: 0 0 5px #000; }
        #tl { top: 10px; left: 10px; } #tr { top: 10px; right: 10px; text-align: right; }
        #bl { bottom: 10px; left: 10px; } #br { bottom: 10px; right: 10px; text-align: right; }

        #controls { height: 180px; background: #080808; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
        .btn { border: none; border-radius: 8px; font-weight: bold; font-family: inherit; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 4px 0 #000; }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        
        #btn-crank { background: #ff00ff; grid-row: span 1; }
        #btn-sync { background: var(--s-glow); color: #000; }
        #btn-auto { background: var(--p-glow); }
        #btn-reset { background: #444; font-size: 10px; }

        #logger { height: 40px; background: #050505; font-size: 9px; padding: 5px; color: var(--p-glow); overflow: hidden; border-top: 1px solid #222; }
    </style>
</head>
<body>

<div id="viewport">
    <div id="canvas-container"></div>
    <div id="tl" class="hud">SPRING_TENSION: <span id="tens-val">0</span>%<br>SCALE: C-MAJOR_LYDIAN</div>
    <div id="tr" class="hud">EVO: <span id="evo-val">1</span>/7<br>HARVEST: <span id="out-val">0</span></div>
    <div id="bl" class="hud">STATUS: <span id="stat-val">IDLE</span><br>ENTROPY: BROKEN</div>
    <div id="br" class="hud">CALEB_CYC: <span id="cyc-val">0</span><br>SYNC_IN: <span id="timer">60</span>s</div>
</div>

<div id="logger"></div>

<div id="controls">
    <button id="btn-crank" class="btn" onmousedown="crank()" ontouchstart="crank()">CRANK SPRING</button>
    <button id="btn-sync" class="btn" onclick="popJack()">SYNC (POP)</button>
    <button id="btn-auto" class="btn" onclick="toggleAuto()">AUTO-FEED</button>
    <button id="btn-reset" class="btn" onclick="reset()">RESET</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    // --- SYSTEM STATE ---
    let tension = 0, scoreIdx = 0, lastTick = 0, timer = 60;
    let isAuto = true, jackPopped = false, audioInit = false;
    let cycles = parseInt(localStorage.getItem('s_cyc')) || 0;
    let pOut = parseInt(localStorage.getItem('s_out')) || 0;

    // --- AUDIO: C-MAJOR WITH 7th F# RESOLUTION ---
    // C4, D4, E4, F4, G4, A4, B4, C5, F#4 (The Trigger)
    const teeth = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25, 369.99];
    const score = [
        {p:0, t:0}, {p:1, t:400}, {p:2, t:800},   // C, D, E (Skips F)
        {p:4, t:1200}, {p:5, t:1600}, {p:6, t:2000}, // G, A, B
        {p:8, t:2400} // The F# Hit (Jack Warning)
    ];

    let audioCtx, masterGain;
    function initAudio() {
        if(audioInit) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.connect(audioCtx.destination);
        audioInit = true;
    }

    function pluck(angle) {
        if(!audioInit) return;
        const toothIdx = Math.floor(((angle + Math.PI) / (Math.PI*2)) * teeth.length) % teeth.length;
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.frequency.setValueAtTime(teeth[toothIdx], audioCtx.currentTime);
        g.gain.setValueAtTime(0.1 * (tension/100), audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.0);
        osc.connect(g).connect(masterGain);
        osc.start(); osc.stop(audioCtx.currentTime + 1.0);
    }

    // --- THREE.JS ENGINE ---
    const scene = new THREE.Scene();
    const container = document.getElementById('canvas-container');
    const camera = new THREE.PerspectiveCamera(75, container.clientWidth/container.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);
    camera.position.z = 12;

    // 14:4 | 28:8 | 56:16
    const core = new THREE.Mesh(new THREE.SphereGeometry(1.4, 16, 16), new THREE.MeshBasicMaterial({ color: 0x00ff41, wireframe: true }));
    const mid = new THREE.Mesh(new THREE.SphereGeometry(2.8, 20, 20), new THREE.MeshBasicMaterial({ color: 0xff6600, wireframe: true, transparent:true, opacity:0.2 }));
    const outer = new THREE.Mesh(new THREE.SphereGeometry(5.6, 32, 32), new THREE.MeshBasicMaterial({ color: 0x00ff41, wireframe: true, transparent:true, opacity:0.1 }));
    scene.add(core, mid, outer);

    const MAX_P = 1000;
    const pData = new Array(MAX_P).fill(null).map(() => ({ r:0, a:0, active:false, isCap:false, op:0.7 }));
    const posArr = new Float32Array(MAX_P * 3);
    const pGeo = new THREE.BufferGeometry();
    pGeo.setAttribute('position', new THREE.BufferAttribute(posArr, 3));
    const pSystem = new THREE.Points(pGeo, new THREE.PointsMaterial({ size: 0.1, color: 0xffffff, transparent:true }));
    scene.add(pSystem);

    function inject(pIdx) {
        initAudio();
        const ports = [0, 45, 90, 135, 180, 225, 270, 315].map(d => d * Math.PI/180);
        for(let i=0; i<MAX_P; i++) {
            if(!pData[i].active) {
                pData[i].active = true; pData[i].r = 5.6; pData[i].a = ports[pIdx];
                pData[i].isCap = false; pData[i].op = 0.7;
                break;
            }
        }
    }

    // --- APP LOGIC ---
    function crank() { tension = Math.min(200, tension + 35); log("SPRING_WINDING..."); }
    function toggleAuto() { isAuto = !isAuto; log(isAuto ? "AUTO_FEED_ON" : "AUTO_FEED_OFF"); }
    function log(m) { const l = document.getElementById('logger'); l.innerHTML = `> ${m}<br>` + l.innerHTML; }

    function popJack() {
        jackPopped = true;
        cycles++;
        localStorage.setItem('s_cyc', cycles);
        log("JACK_POP_SEQUENCE_INIT");
        setTimeout(() => { jackPopped = false; core.scale.set(1,1,1); }, 1000);
    }

    function animate(now) {
        requestAnimationFrame(animate);
        
        // Spring Physics
        tension = Math.max(0, tension - 0.15);
        let playSpeed = Math.pow(tension/100, 1.5);
        
        // Sequencer
        if(isAuto && tension > 2) {
            let loop = (now * playSpeed) % 3200;
            if(loop > score[scoreIdx].t && lastTick <= score[scoreIdx].t) {
                inject(score[scoreIdx].p);
                scoreIdx = (scoreIdx + 1) % score.length;
            }
            lastTick = loop;
        }

        // Mechanical Wind (Jitter)
        let wind = (tension/200) * Math.sin(now*0.05);
        core.rotation.y += playSpeed * 0.1;
        
        for(let i=0; i<MAX_P; i++) {
            if(pData[i].active) {
                const idx = i*3;
                if(!pData[i].isCap) {
                    pData[i].r -= 0.02 * playSpeed;
                    pData[i].a += (playSpeed * 0.05) + (wind * 0.01);
                } else {
                    pData[i].a += 0.2; // Fast Orbit
                    pData[i].op -= 0.02;
                }

                posArr[idx] = Math.cos(pData[i].a) * pData[i].r;
                posArr[idx+1] = (Math.sin(pData[i].a) * 0.1 * pData[i].r) + wind;
                posArr[idx+2] = Math.sin(pData[i].a) * pData[i].r;

                if(pData[i].r < 1.4 && !pData[i].isCap) {
                    pData[i].isCap = true; pData[i].r = 1.4;
                    pOut++; localStorage.setItem('s_out', pOut);
                    pluck(pData[i].a);
                    core.scale.set(1.2, 1.2, 1.2);
                }
                if(pData[i].isCap && pData[i].op <= 0) {
                    pData[i].active = false;
                    posArr[idx] = posArr[idx+1] = posArr[idx+2] = 5000;
                }
            }
        }
        
        if(jackPopped) {
            core.scale.set(3,3,3);
            camera.position.z = 12 + Math.random();
        } else if(core.scale.x > 1) {
            core.scale.subScalar(0.02);
        }

        pGeo.attributes.position.needsUpdate = true;
        document.getElementById('tens-val').innerText = Math.floor(tension);
        document.getElementById('out-val').innerText = pOut;
        document.getElementById('cyc-val').innerText = cycles;
        document.getElementById('evo-val').innerText = Math.min(7, Math.floor(cycles/10) + 1);
        document.getElementById('stat-val').innerText = tension > 5 ? "PLAYING" : "WIND_ME";
        
        renderer.render(scene, camera);
    }

    setInterval(() => { if(timer > 0) timer--; else { timer=60; popJack(); } document.getElementById('timer').innerText = timer; }, 1000);
    animate(0);
    function reset() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SULTAN_SOVEREIGN_1.6.2</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: none; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: #000; margin: 0; height: 100vh; font-family: 'VT323', monospace; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #device { background: #0a0a0a; width: 100vw; height: 100vh; max-width: 450px; display: flex; flex-direction: column; border: 2px solid #ff6600; box-shadow: 0 0 20px rgba(255,102,0,0.2); }
        #viewport { width: 100%; height: 65%; background: #000; position: relative; border-bottom: 2px solid #333; overflow: hidden; }
        #viewport::after { content: ""; position: absolute; inset: 0; background: repeating-linear-gradient(rgba(0,0,0,0) 0, rgba(0,0,0,0.1) 10px, transparent 2px); pointer-events: none; z-index: .5; }
        #canvas-container { width: 100%; height: 100%; }
        .hud { position: absolute; font-size: 8px; font-weight: 600; z-index: 10; pointer-events: none; letter-spacing: 10px; text-shadow: 0 0 5px currentColor; }
        #tl { top: 8px; left: 10px; color: #ff00ff; } #tr { top: 8px; right: 10px; text-align: right; color: #ffff00; }
        #bl { bottom: 8px; left: 10px; color: #ff00ff; } #br { bottom: 8px; right: 10px; text-align: right; color: #ffff00; }
        #logger { height: 50px; background: #050505; border-bottom: 1px solid #222; padding: 10px; font-size: 6px; color: #ff6600; overflow: hidden; display: flex; flex-direction: column-reverse; }
        #tactile-zone { flex-grow: 1; position: relative; background: #080808; background-image: radial-gradient(#151515 .5px, transparent 1px); background-size: 40px 20px; }
        .actuator { width: 195px; height: 195px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 12px; font-weight: 900; box-shadow: 10px 40px 0 #000; position: absolute; transition: transform 0.05s; }
        .actuator:active { transform: scale(0.2); filter: brightness(1.5); }
        #btn-a { bottom: 70px; right: 5px; background: #ff6600; border: 8px solid #993300; } 
        #btn-b { bottom: 60px; right: 90px; background: #00ff00; border: 8px solid #008800; color: #000; } 
        #btn-rpm { bottom: 30px; left: 60px; background: #ff6600; border: 4px solid #993300; }
        #btn-mute { bottom: 60px; left: 90px; width: 60px; height: 30px; background: #222; border: 3px solid #444; font-size: 12px; }
        .power-off-mask { position: absolute; top:0; left:0; width:100%; height:100%; background:#000; z-index:100; display:none; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="device">
    <div id="viewport">
        <div id="power-mask" class="power-off-mask"></div>
        <div id="canvas-container"></div>
        <div id="tl" class="hud">LÂ©SS: <span id="f-val">0</span><br>ACTIVE: <span id="a-val">0</span></div>
        <div id="tr" class="hud">SPUN: <span id="r-val">0</span><br>OUT: <span id="p-out">0</span></div>
        <div id="bl" class="hud">HIDDEN SULTAN: <span id="p-tot">0</span><br>HIDDEN EAGLE: <span id="timer">0</span>s</div>
        <div id="br" class="hud">CALEB: <span id="cycles">0</span><br>KING of CODE</div>
    </div>
    <div id="logger"></div>
    <div id="tactile-zone">
        <div id="btn-rpm" class="actuator" ontouchstart="startRPMBoost()">H</div> ontouchend="stopRPMBoost()">$</div> ontouchcancel="stopRPMBoost()">+</div>
        <div id="btn-mute" class="actuator" ontouchstart="toggleMute()">ðŸ”Š</div>
        <div id="btn-b" class="actuator" ontouchstart="manualCycle()">âˆ†</div>
        <div id="btn-a" class="actuator" ontouchstart="injectParticles()">Â§</div>
    </div>
</div>

<script>
    // --- PERSISTENCE ---
    const saved = JSON.parse(localStorage.getItem('sultanReactor')) || {};
    let rpm = saved.rpm || 0, pIn = saved.pIn || 0, pOut = saved.pOut || 0, pTot = saved.pTot || 0, cycles = saved.cycles || 0, timeLeft = 60;
    
    // --- AUDIO ENGINE: CELTIC PROTOCOL ---
    let audioCtx = null, droneOsc = null, droneGain = null, lastToneTime = 0, isMuted = false, audioInitialized = false;
    const healingFreqs = [174, 285, 396, 417, 528, 639, 741, 852, 963];

    function startAudioIfNeeded() {
        if (audioInitialized) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const tOsc = audioCtx.createOscillator(); const tGain = audioCtx.createGain();
        tGain.gain.value = 0.0001; tOsc.connect(tGain).connect(audioCtx.destination);
        tOsc.start(); tOsc.stop(audioCtx.currentTime + 0.01);
        log("CELTIC_RESONANCE_INIT", "milestone");
        audioInitialized = true;
    }

    function toggleMute() {
        isMuted = !isMuted;
        if (droneGain) droneGain.gain.setTargetAtTime(isMuted ? 0 : 0.008, audioCtx.currentTime, 0.2);
        document.getElementById('btn-mute').innerText = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
    }

    function startDrone() {
        if (droneOsc || !audioCtx) return;
        droneOsc = audioCtx.createOscillator(); droneOsc.type = 'sine';
        droneOsc.frequency.setValueAtTime(174, audioCtx.currentTime); // Grounding frequency [cite: 2026-02-05]
        droneGain = audioCtx.createGain(); droneGain.gain.setValueAtTime(0, audioCtx.currentTime);
        droneGain.gain.linearRampToValueAtTime(isMuted ? 0 : 0.008, audioCtx.currentTime + 3);
        droneOsc.connect(droneGain).connect(audioCtx.destination); droneOsc.start();
    }

    function playTone() {
        if (!audioCtx || isMuted || audioCtx.state !== 'running') return;
        const now = audioCtx.currentTime;
        const streamSpeed = Math.max(0.06, 0.2 - (rpm / 1500000));
        if (now - lastToneTime < streamSpeed) return; lastToneTime = now;

        // Select Celtic Tier based on 14:4, 28:8, 56:16 spheres [cite: 2026-02-05]
        let freq = (rpm > 900000) ? healingFreqs[Math.floor(Math.random()*3)+6] : (rpm > 400000) ? 528 : healingFreqs[Math.floor(Math.random()*4)];

        const osc = audioCtx.createOscillator();
        osc.type = 'triangle'; // Woodwind body
        osc.frequency.setValueAtTime(freq, now);
        
        // Celtic Vibrato
        const vibrato = audioCtx.createOscillator();
        vibrato.frequency.value = 5.5;
        const vGain = audioCtx.createGain();
        vGain.gain.value = freq * 0.005;
        vibrato.connect(vGain).connect(osc.frequency);
        vibrato.start();

        // Breath Component
        const noise = audioCtx.createBufferSource();
        const bSize = audioCtx.sampleRate * 0.4;
        const b = audioCtx.createBuffer(1, bSize, audioCtx.sampleRate);
        const d = b.getChannelData(0);
        for(let i=0; i<bSize; i++) d[i] = Math.random() * 2 - 1;
        noise.buffer = b;
        const nFilter = audioCtx.createBiquadFilter();
        nFilter.type = 'bandpass'; nFilter.frequency.value = freq * 2;
        const nGain = audioCtx.createGain();
        nGain.gain.setValueAtTime(0.015, now); nGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.3);

        const mGain = audioCtx.createGain();
        const pan = audioCtx.createStereoPanner();
        pan.pan.value = (Math.random()*2-1) * 0.4;

        mGain.gain.setValueAtTime(0, now);
        mGain.gain.linearRampToValueAtTime(0.12, now + 0.04);
        mGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.8);

        osc.connect(mGain); noise.connect(nFilter).connect(nGain).connect(mGain);
        mGain.connect(pan).connect(audioCtx.destination);
        osc.start(); noise.start(); osc.stop(now + 0.8); vibrato.stop(now + 0.8);
        
        if (typeof core !== 'undefined') { core.material.color.set(0x88ff88); setTimeout(() => core.material.color.set(0x00ff00), 100); }
    }

    // --- CORE LOGIC ---
    const MAX_P = 2500;
    const pData = new Array(MAX_P).fill(null).map(() => ({ r: 0, a: 0, L: 0, active: false, burst: 0, color: [1,1,1] }));
    const logBox = document.getElementById('logger');
    const mask = document.getElementById('power-mask');
    let rpmInterval = null;

    function log(msg, type='') {
        const e = document.createElement('div'); e.innerText = `[${new Date().toLocaleTimeString([], {hour12:false})}] ${msg}`;
        if(type === 'milestone') e.style.color = '#00ff00';
        logBox.prepend(e); if(logBox.children.length > 15) logBox.removeChild(logBox.lastChild);
    }

    function adjRPM() { 
        startAudioIfNeeded(); 
        rpm = Math.floor((rpm * 1.1) + 100); 
        playTone(); // Create steady stream [cite: 2026-02-05]
    }
    function startRPMBoost() { adjRPM(); if(rpmInterval) clearInterval(rpmInterval); rpmInterval = setInterval(adjRPM, 100); }
    function stopRPMBoost() { if (rpmInterval) { clearInterval(rpmInterval); rpmInterval = null; } }

    function injectParticles() {
        startAudioIfNeeded();
        const maxSpawn = Math.min(600, 100 + Math.floor(rpm / 5000));
        let spawned = 0;
        for(let i=0; i<MAX_P && spawned < maxSpawn; i++) {
            if(!pData[i].active) {
                pData[i].active = true; pData[i].r = 7 + Math.random() * 2; pData[i].burst = 1.5 + Math.random() * 1.5;
                pData[i].a = Math.random() * Math.PI * 2; pData[i].L = 0.015 + Math.random() * 0.025;
                pData[i].color = Math.random() > 0.5 ? [1,1,0] : [1,0,1]; spawned++;
            }
        }
        pIn += spawned; log(`P_INJECTION: +${spawned}`);
    }

    function manualCycle() { startAudioIfNeeded(); log("MANUAL_INTERRUPT"); executeTest(); }

    function executeTest() {
        const state = { rpm, pIn, pOut, pTot, cycles }; mask.style.display = 'block';
        log("MIRROR_SYNC_INITIATED...");
        setTimeout(() => {
            Object.assign(window, state); cycles++; mask.style.display = 'none';
            document.getElementById('cycles').innerText = cycles; 
            log(`SYNC_COMPLETE: CYCLE_${cycles}`, 'milestone');
            timeLeft = 60; localStorage.setItem('sultanReactor', JSON.stringify({rpm, pIn, pOut, pTot, cycles}));
        }, 1200);
    }

    setInterval(() => { if(mask.style.display !== 'block') { timeLeft--; if(timeLeft <= 0) executeTest(); document.getElementById('timer').innerText = timeLeft; }}, 1000);

    // --- RENDERER ---
    const scene = new THREE.Scene(); const view = document.getElementById('canvas-container');
    const camera = new THREE.PerspectiveCamera(75, view.clientWidth / view.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: false, alpha: true });
    renderer.setSize(view.clientWidth, view.clientHeight); view.appendChild(renderer.domElement);

    const posArr = new Float32Array(MAX_P * 3); const colArr = new Float32Array(MAX_P * 3);
    const pGeo = new THREE.BufferGeometry(); pGeo.setAttribute('position', new THREE.BufferAttribute(posArr, 3)); pGeo.setAttribute('color', new THREE.BufferAttribute(colArr, 3));
    const pSystem = new THREE.Points(pGeo, new THREE.PointsMaterial({ size: 0.25, vertexColors: true, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending }));
    scene.add(pSystem);

    const core = new THREE.Mesh(new THREE.SphereGeometry(1.4, 8, 8), new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true }));
    const mid = new THREE.Mesh(new THREE.SphereGeometry(2.8, 12, 12), new THREE.MeshBasicMaterial({ color: 0xff6600, wireframe: true }));
    const outer = new THREE.Mesh(new THREE.SphereGeometry(5.6, 16, 16), new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true, transparent:true, opacity:0.15 }));
    const glow = new THREE.Mesh(new THREE.SphereGeometry(5.8, 16, 16), new THREE.MeshBasicMaterial({ color: 0x00ff88, transparent: true, opacity: 0.1, blending: THREE.AdditiveBlending }));
    scene.add(core, mid, outer, glow); camera.position.z = 12;

    function animate() {
        requestAnimationFrame(animate);
        if(mask.style.display === 'block') return;
        rpm = Math.max(0, rpm - 1);
        if(rpm > 10000 && !droneOsc) startDrone(); 
        
        glow.material.opacity = 0.08 + Math.min(0.25, rpm/2000000);
        core.rotation.y += (rpm/50000); mid.rotation.x -= (rpm/100000); outer.rotation.z += (rpm/2000000);
        
        let activeCount = 0; const baseVel = (rpm/400000);
        for(let i=0; i<MAX_P; i++) {
            if(pData[i].active) {
                if(pData[i].burst > 0) { pData[i].r += pData[i].burst; pData[i].burst -= 0.1; }
                const gPull = 1.2 * (rpm/150000) / Math.max(0.6, pData[i].r**2);
                pData[i].r -= (baseVel + gPull); pData[i].a += (pData[i].L / Math.max(0.5, pData[i].r**2));
                const idx = i*3; posArr[idx] = Math.cos(pData[i].a)*pData[i].r; posArr[idx+1] = Math.sin(pData[i].a*0.5)*0.5; posArr[idx+2] = Math.sin(pData[i].a)*pData[i].r;
                colArr[idx] = pData[i].color[0]; colArr[idx+1] = pData[i].color[1]; colArr[idx+2] = pData[i].color[2];
                if(pData[i].r < 1.4) { pData[i].active = false; posArr[idx] = posArr[idx+1] = posArr[idx+2] = 5000; pOut++; pTot++; playTone(); } else activeCount++;
            }
        }
        pGeo.attributes.position.needsUpdate = true; pGeo.attributes.color.needsUpdate = true;
        document.getElementById('r-val').innerText = Math.floor(rpm).toLocaleString();
        document.getElementById('p-out').innerText = pOut.toLocaleString();
        document.getElementById('p-tot').innerText = pTot.toLocaleString();
        document.getElementById('a-val').innerText = activeCount;
        renderer.render(scene, camera);
    }
    log("SULTAN_SOVEREIGN_1.6.2 ONLINE", "milestone");
    animate();
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
</script>
</body>
</html>

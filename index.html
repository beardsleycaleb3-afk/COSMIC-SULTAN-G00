<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SULTAN_SOVEREIGN_1.6.2_GOLD</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: none; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: #000; margin: 0; height: 100vh; font-family: 'VT323', monospace; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #device { background: #0a0a0a; width: 100vw; height: 100vh; max-width: 450px; display: flex; flex-direction: column; border: 2px solid #ff6600; box-shadow: 0 0 30px rgba(255,102,0,0.2); }
        #viewport { width: 100%; height: 35%; background: #000; position: relative; border-bottom: 2px solid #333; overflow: hidden; }
        #viewport::after { content: ""; position: absolute; inset: 0; background: repeating-linear-gradient(rgba(0,0,0,0) 0, rgba(0,0,0,0.1) 1px, transparent 2px); pointer-events: none; z-index: 5; }
        #canvas-container { width: 100%; height: 100%; }
        .hud { position: absolute; font-size: 14px; font-weight: 900; z-index: 10; pointer-events: none; letter-spacing: 1px; text-shadow: 0 0 5px currentColor; }
        #tl { top: 8px; left: 10px; color: #ff00ff; } #tr { top: 8px; right: 10px; text-align: right; color: #ffff00; }
        #bl { bottom: 8px; left: 10px; color: #ff00ff; } #br { bottom: 8px; right: 10px; text-align: right; color: #ffff00; }
        #logger { height: 130px; background: #050505; border-bottom: 1px solid #222; padding: 10px; font-size: 13px; color: #ff6600; overflow: hidden; display: flex; flex-direction: column-reverse; }
        #tactile-zone { flex-grow: 1; position: relative; background: #080808; background-image: radial-gradient(#151515 1px, transparent 1px); background-size: 20px 20px; }
        .actuator { width: 95px; height: 95px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 32px; font-weight: 900; box-shadow: 4px 4px 0 #000; position: absolute; transition: transform 0.05s; }
        .actuator:active { transform: scale(0.92); filter: brightness(1.5); }
        #btn-a { bottom: 160px; right: 30px; background: #ff6600; border: 4px solid #993300; } 
        #btn-b { bottom: 30px; right: 110px; background: #00ff00; border: 4px solid #008800; color: #000; } 
        #btn-rpm { bottom: 30px; left: 30px; background: #ff6600; border: 4px solid #993300; }
        #btn-mute { bottom: 30px; left: 135px; width: 60px; height: 60px; background: #222; border: 3px solid #444; font-size: 24px; }
        .power-off-mask { position: absolute; top:0; left:0; width:100%; height:100%; background:#000; z-index:100; display:none; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="device">
    <div id="viewport">
        <div id="power-mask" class="power-off-mask"></div>
        <div id="canvas-container"></div>
        <div id="tl" class="hud">FPS: <span id="f-val">0</span><br>ACTIVE: <span id="a-val">0</span></div>
        <div id="tr" class="hud">RPM: <span id="r-val">0</span><br>OUT: <span id="p-out">0</span></div>
        <div id="bl" class="hud">Î£ MASS: <span id="p-tot">0</span><br>CYCLE: <span id="timer">60</span>s</div>
        <div id="br" class="hud">SURVIVAL: <span id="cycles">0</span><br>MIRROR: ACTIVE</div>
    </div>
    <div id="logger"></div>
    <div id="tactile-zone">
        <div id="btn-rpm" class="actuator" ontouchstart="startRPMBoost()" ontouchend="stopRPMBoost()" ontouchcancel="stopRPMBoost()">+</div>
        <div id="btn-mute" class="actuator" ontouchstart="toggleMute()">ðŸ”Š</div>
        <div id="btn-b" class="actuator" ontouchstart="manualCycle()">B</div>
        <div id="btn-a" class="actuator" ontouchstart="injectParticles()">A</div>
    </div>
</div>

<script>
    // --- PERSISTENCE & GLOBAL STATE ---
    const saved = JSON.parse(localStorage.getItem('sultanReactor')) || {};
    let rpm = saved.rpm || 0, pIn = saved.pIn || 0, pOut = saved.pOut || 0, pTot = saved.pTot || 0, cycles = saved.cycles || 0, timeLeft = 60;
    const hF = [174, 285, 396, 417, 528, 639, 741, 852, 963]; // Solfeggio Table [cite: 2026-02-05]
    
    // --- BLACK BOX AUDIO KERNEL (CELTIC PROTOCOL 1.6.2) ---
    let aCtx = null, dO = null, dG = null, lTT = 0, iM = false, aI = false;
    function startAudioIfNeeded() {
        if (aI) return; aCtx = new (window.AudioContext || window.webkitAudioContext)();
        const t = aCtx.createOscillator(); const g = aCtx.createGain(); g.gain.value = 0.0001; t.connect(g).connect(aCtx.destination);
        t.start(); t.stop(aCtx.currentTime + 0.01); log("CELTIC_PROTOCOL_ENGAGED", "milestone"); aI = true;
    }
    function toggleMute() { iM = !iM; if (dG) dG.gain.setTargetAtTime(iM ? 0 : 0.008, aCtx.currentTime, 0.2); document.getElementById('btn-mute').innerText = iM ? 'ðŸ”‡' : 'ðŸ”Š'; }
    function startDrone() {
        if (dO || !aCtx) return; dO = aCtx.createOscillator(); dO.type = 'sine'; dO.frequency.setValueAtTime(174, aCtx.currentTime);
        dG = aCtx.createGain(); dG.gain.setValueAtTime(0, aCtx.currentTime); dG.gain.linearRampToValueAtTime(iM ? 0 : 0.008, aCtx.currentTime + 3);
        dO.connect(dG).connect(aCtx.destination); dO.start();
    }
    function playTone() {
        if (!aCtx || iM || aCtx.state !== 'running') return; const n = aCtx.currentTime;
        const sS = Math.max(0.06, 0.2 - (rpm / 1500000)); if (n - lTT < sS) return; lTT = n;
        let f = (rpm > 900000) ? hF[Math.floor(Math.random()*3)+6] : (rpm > 400000) ? 528 : hF[Math.floor(Math.random()*4)];
        const o = aCtx.createOscillator(); o.type = 'triangle'; o.frequency.setValueAtTime(f, n);
        const v = aCtx.createOscillator(); v.frequency.value = 5.5; const vG = aCtx.createGain(); vG.gain.value = f * 0.005;
        v.connect(vG).connect(o.frequency); v.start();
        const ns = aCtx.createBufferSource(); const bS = aCtx.sampleRate * 0.4; const b = aCtx.createBuffer(1, bS, aCtx.sampleRate);
        const d = b.getChannelData(0); for(let i=0; i<bS; i++) d[i] = Math.random() * 2 - 1; ns.buffer = b;
        const nF = aCtx.createBiquadFilter(); nF.type = 'bandpass'; nF.frequency.value = f * 2;
        const nG = aCtx.createGain(); nG.gain.setValueAtTime(0.015, n); nG.gain.exponentialRampToValueAtTime(0.0001, n + 0.3);
        const mG = aCtx.createGain(); const p = aCtx.createStereoPanner(); p.pan.value = (Math.random()*2-1)*0.4;
        mG.gain.setValueAtTime(0, n); mG.gain.linearRampToValueAtTime(0.12, n + 0.04); mG.gain.exponentialRampToValueAtTime(0.0001, n + 0.8);
        o.connect(mG); ns.connect(nF).connect(nG).connect(mG); mG.connect(p).connect(aCtx.destination);
        o.start(); ns.start(); o.stop(n+0.8); v.stop(n+0.8);
        if (typeof core !== 'undefined') { core.material.color.set(0x88ff88); setTimeout(() => core.material.color.set(0x00ff00), 100); }
    }

    // --- REACTOR CORE LOGIC ---
    const MAX_P = 2500;
    const pData = new Array(MAX_P).fill(null).map(() => ({ r: 0, a: 0, L: 0, active: false, burst: 0, color: [1,1,1] }));
    const logBox = document.getElementById('logger'); const mask = document.getElementById('power-mask');
    let rpmInt = null;
    function log(msg, type='') {
        const e = document.createElement('div'); e.innerText = `[${new Date().toLocaleTimeString([], {hour12:false})}] ${msg}`;
        if(type === 'milestone') e.style.color = '#00ff00';
        logBox.prepend(e); if(logBox.children.length > 15) logBox.removeChild(logBox.lastChild);
    }
    function adjRPM() { startAudioIfNeeded(); rpm = Math.floor((rpm * 1.1) + 100); playTone(); }
    function startRPMBoost() { adjRPM(); if(rpmInt) clearInterval(rpmInt); rpmInt = setInterval(adjRPM, 100); }
    function stopRPMBoost() { if (rpmInt) { clearInterval(rpmInt); rpmInt = null; } }
    function injectParticles() {
        startAudioIfNeeded(); const mS = Math.min(600, 100 + Math.floor(rpm / 5000)); let s = 0;
        for(let i=0; i<MAX_P && s < mS; i++) {
            if(!pData[i].active) {
                pData[i].active = true; pData[i].r = 7 + Math.random() * 2; pData[i].burst = 1.5 + Math.random() * 1.5;
                pData[i].a = Math.random() * Math.PI * 2; pData[i].L = 0.015 + Math.random() * 0.025;
                pData[i].color = Math.random() > 0.5 ? [1,1,0] : [1,0,1]; s++;
            }
        }
        pIn += s; log(`P_INJECTION: +${s}`);
    }
    function manualCycle() { startAudioIfNeeded(); log("MANUAL_INTERRUPT"); executeTest(); }
    function executeTest() {
        const state = { rpm, pIn, pOut, pTot, cycles }; mask.style.display = 'block'; log("MIRROR_SYNC_INITIATED...");
        setTimeout(() => {
            Object.assign(window, state); cycles++; mask.style.display = 'none';
            document.getElementById('cycles').innerText = cycles; log(`SYNC_COMPLETE: CYCLE_${cycles}`, 'milestone');
            timeLeft = 60; localStorage.setItem('sultanReactor', JSON.stringify({rpm, pIn, pOut, pTot, cycles}));
        }, 1200);
    }
    setInterval(() => { if(mask.style.display !== 'block') { timeLeft--; if(timeLeft <= 0) executeTest(); document.getElementById('timer').innerText = timeLeft; }}, 1000);

    // --- RENDERER & COSMIC SYMMETRY --- [cite: 2026-02-05]
    const scene = new THREE.Scene(); const view = document.getElementById('canvas-container');
    const camera = new THREE.PerspectiveCamera(75, view.clientWidth / view.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: false, alpha: true });
    renderer.setSize(view.clientWidth, view.clientHeight); view.appendChild(renderer.domElement);
    const posArr = new Float32Array(MAX_P * 3); const colArr = new Float32Array(MAX_P * 3);
    const pGeo = new THREE.BufferGeometry(); pGeo.setAttribute('position', new THREE.BufferAttribute(posArr, 3)); pGeo.setAttribute('color', new THREE.BufferAttribute(colArr, 3));
    const pSystem = new THREE.Points(pGeo, new THREE.PointsMaterial({ size: 0.25, vertexColors: true, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending }));
    scene.add(pSystem);
    const core = new THREE.Mesh(new THREE.SphereGeometry(1.4, 8, 8), new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true }));
    const mid = new THREE.Mesh(new THREE.SphereGeometry(2.8, 12, 12), new THREE.MeshBasicMaterial({ color: 0xff6600, wireframe: true }));
    const outer = new THREE.Mesh(new THREE.SphereGeometry(5.6, 16, 16), new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true, transparent:true, opacity:0.15 }));
    const glow = new THREE.Mesh(new THREE.SphereGeometry(5.8, 16, 16), new THREE.MeshBasicMaterial({ color: 0x00ff88, transparent: true, opacity: 0.1, blending: THREE.AdditiveBlending }));
    scene.add(core, mid, outer, glow); camera.position.z = 12;

    function animate() {
        requestAnimationFrame(animate); if(mask.style.display === 'block') return;
        rpm = Math.max(0, rpm - 1); if(rpm > 10000 && !dO) startDrone(); 
        glow.material.opacity = 0.08 + Math.min(0.25, rpm/2000000);
        core.rotation.y += (rpm/50000); mid.rotation.x -= (rpm/100000); outer.rotation.z += (rpm/2000000);
        
        let aC = 0; const bV = (rpm/400000);
        for(let i=0; i<MAX_P; i++) {
            if(pData[i].active) {
                if(pData[i].burst > 0) { pData[i].r += pData[i].burst; pData[i].burst -= 0.1; }
                const gP = 1.2 * (rpm/150000) / Math.max(0.6, pData[i].r**2);
                pData[i].r -= (bV + gP); pData[i].a += (pData[i].L / Math.max(0.5, pData[i].r**2));
                
                // Radial Symmetry Snapping [cite: 2026-02-05]
                if(rpm > 144000 && Math.abs(pData[i].r - 1.4) < 0.1) pData[i].r = 1.4;
                if(rpm > 288000 && Math.abs(pData[i].r - 2.8) < 0.1) pData[i].r = 2.8;
                if(rpm > 566000 && Math.abs(pData[i].r - 5.6) < 0.1) pData[i].r = 5.6;

                const idx = i*3; posArr[idx] = Math.cos(pData[i].a)*pData[i].r; posArr[idx+1] = Math.sin(pData[i].a*0.5)*0.5; posArr[idx+2] = Math.sin(pData[i].a)*pData[i].r;
                colArr[idx] = pData[i].color[0]; colArr[idx+1] = pData[i].color[1]; colArr[idx+2] = pData[i].color[2];
                if(pData[i].r < 1.4) { pData[i].active = false; posArr[idx] = posArr[idx+1] = posArr[idx+2] = 5000; pOut++; pTot++; playTone(); } else aC++;
            }
        }
        pGeo.attributes.position.needsUpdate = true; pGeo.attributes.color.needsUpdate = true;
        document.getElementById('r-val').innerText = Math.floor(rpm).toLocaleString();
        document.getElementById('p-out').innerText = pOut.toLocaleString();
        document.getElementById('p-tot').innerText = pTot.toLocaleString();
        document.getElementById('a-val').innerText = aC;
        renderer.render(scene, camera);
    }
    log("SULTAN_SOVEREIGN_1.6.2_GOLD ONLINE", "milestone"); animate();
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
</script>
</body>
</html>
